# Calculate distance to frontier

NOTE: We have to add the dynamic benchmarking that Shel has designed for us.

- Inputs:
  - `data/output/compiled_indicators.rds`
  - `data/outut/country_list.rds`
  - `data/output/db_variables.rds`
      
- Outputs:
 - `data/output/closeness_to_frontier.rds`
 - `data/output/closeness_to_frontier_long.rds`
 - `data/output/closeness_to_frontier_dynamic.rds`
 - `data/output/closeness_to_frontier_dynamic_long.rds`

## Calculate global closeness to frontier

Closeness to frontier (CTF) is global, meaning that we identify the worst and best performance in the full sample (all countries). For each indicator $i$, we compare the last available value of indicator $i$ with the worst and best
performance for indicator $i$ among all countries and in the last $y$ years (2013 - most recent data).^[In [the doing business report](https://www.doingbusiness.org/content/dam/doingBusiness/media/Annual-Reports/English/DB17-Chapters/DB17-DTF-and-DBRankings.pdf) they consider the last 5 years, but here for some indicators we have shorter time series].


## 1. Read in data and keep only data from after 2013

Ideally, this will use data for the last 7 years in any given year

```{r}

#load in cleaned indicators from step file 03-clean-countries
cliar_indicators <-
  read_rds(
    here(
      "data",
      "output",
      "compiled_indicators.rds"
    )
  ) %>%
  # we subset our data to the post-2013 period.
  # note: for the static exercise, we further subset to time period after 2018.
  # for the dynamic exercise, we maintain our cutpoint at 2013.
  filter(
    year >= 2013
  )

#read in country list from step 3
country_list <- read_rds(
  here(
    "data",
    "output",
    "wb_country_list.rds"
  )
)

#read in db_variables
db_variables <- read_rds(
  here(
    "data",
    "output",
    "db_variables.rds"
  )
)

#filter out the variables that are marked for benchmarking 
vars_ctf <- db_variables |> 
  filter(
    benchmarked_ctf == "Yes"
  ) |> 
  pull(variable)
```

## 2. Rescale indicators so a higher number denotes stronger institutions
V-DEM: corruptionPRM indicators: Countries are graded between 0 (less control/involvement) and 6 (more control/involvement). 
    In order to rescale these indicators, the years after 2018 are selected, 
    and then each indicator value is subtracted from 6. so that a value that was
    previously 0 for less control, is now 6, indicating a stronger institution.
    
    NOTE:
    Methodological note for PRM indicates that 1998 and 2013 indicators are 
    comparable, but not with 2018 due to change in methodology, so we only retain
    post-2018 data.
    
Enterprise Survey: Percent Of Firms Identifying X As A Major Constraint
    Subtract each indicator from 100, so that a low percentage of firm, for example
    10%, will now have a score of 90, indicating stronger institutions
    
Freedom house: Countries are graded between 1 (most free) and 7 (least free)
    Subtract each indicator from 8 so that a value of 1 for the most free is now 7,
    indicating stronger institutions
```{r}
#create new table to hold rescaled values
cliar_indicators_rescaled <- cliar_indicators |>
  mutate(
    # V-DEM: corruption
    # PRM indicators: Countries are graded between 0 (less control/involvement) and 6 (more control/involvement).
    # Methodological note for PRM indicates that 1998 and 2013 indicators are comparable,
    # but not with 2018 due to change in methodology, so we only retain post-2018 data.
    across(
      c(
        starts_with("oecd_pmr")
      ),
      ~ ifelse(year < 2018, NA, 6 - .x)
    ),
    # Enterprise Survey: Percent Of Firms Identifying X As A Major Constraint
    across(
      c(starts_with("wb_enterprisesurveys")),
      ~ 100 - .
    ),
    # Freedom house: Countries are graded between 1 (most free) and 7 (least free)
    across(
      c(starts_with("fh_fiw")),
      ~ (8 - .x)
    )
  )
```


## 3. Calculate country-level average for each indicator

For the static benchmark, we only calculate averages for indicators starting in the year 2018.

```{r}
country_average <-
  #filter only data from years we are using
  cliar_indicators_rescaled %>%
  filter(year >= 2018) |> 
  #this groups countries together so average can be taken 
  group_by(
    country_code
  ) %>%
  summarise(
    across(
      #take average of all variables marked for ctf
      all_of(c(vars_ctf, "wdi_nygdppcapppkd")),
      ~ mean(., na.rm = TRUE)
    )
  )
```

## 4. Identify worst and best performance for each indicator

Find this information both on a global time-scale, and for each individual year.

Inspect the entire dataset of rescaled indicator values - so including the indicator
values for every country year after 2013 - and identify the lowes tand highest 
values in each category. 
```{r}
# static
# find min and max values for global dataset of all years
min_max <-
  cliar_indicators_rescaled %>%
  filter(year >= 2018) |>
  summarise(
    across(
      all_of(vars_ctf),
      list(
        min = ~ min(., na.rm = TRUE),
        max = ~ max(., na.rm = TRUE)
      ),
      .names = "{.col}-{.fn}"
    )
  ) %>%
  pivot_longer(
    everything(),
    names_to = c("variable", ".value"),
    names_pattern = "(.*)-(.*)"
  )

# dynamic: note that there are quite a few cases of Infinite warnings (due to missingness)
# find min and max values for each indicator for each year
min_max_dynamic <- cliar_indicators_rescaled %>%
  group_by(year) %>%
  summarise(
    across(
      all_of(vars_ctf),
      list(
        min = ~ min(., na.rm = TRUE),
        max = ~ max(., na.rm = TRUE)
      ),
      .names = "{.col}-{.fn}"
    )
  ) %>%
  pivot_longer(
    -year,
    names_to = c("variable", ".value"),
    names_pattern = "(.*)-(.*)"
  ) %>%
  filter(!is.infinite(min) & !is.infinite(max))
```

## 5. Calculate closeness to frontier at indicator level

The CTF is calculated with this formula  ctf = (min - value) / (min - max)
meaning each country's average value for each indicator is subtracted from the 
minumun value of that indicator, and this number is divided by the total range of
the indicator.

```{r}

#calculate the static ctf
ctf <-
  #take the country average data created in step 3
  country_average %>%
  pivot_longer(
    all_of(vars_ctf),
    names_to = "variable"
  ) %>%
  #combine average data with min and max level, merging by indicator
  left_join(
    min_max,
    by = "variable"
  ) %>%
  mutate(
    #ctf formula
    ctf = (min - value) / (min - max),
    ctf = ifelse(
      ctf == 0,
      0.01,
      ctf
    )
  #clean data to save in a readable format
  ) %>%
  pivot_wider(
    id_cols = c("country_code"),
    names_from = "variable",
    values_from = "ctf"
  ) %>%
  select(-starts_with("gdp")) %>%
  left_join(
    country_average %>%
      select(country_code)
  )

#calculate dynamic ctf
ctf_dynamic <-
  #use rescaled data for this calculation
  cliar_indicators_rescaled %>%
  pivot_longer(
    all_of(vars_ctf),
    names_to = "variable"
  ) %>%
  #combine with min max data 
  left_join(
    min_max_dynamic,
    by = c("year", "variable")
  ) %>%
  mutate(
    #ctf formula
    ctf_dyn = (min - value) / (min - max),
    ctf_dyn = ifelse(
      ctf_dyn == 0,
      0.01,
      ctf_dyn
    )
  #clean data for saving
  ) %>%
  pivot_wider(
    id_cols = c("country_code", "year"),
    names_from = "variable",
    values_from = "ctf_dyn"
  ) %>%
  left_join(
    cliar_indicators_rescaled %>%
      select(country_code, year)
  )
```

## 6. Calculate median per group

Group countries by regional, economic, or income groups and take indicator median
for those groups
```{r}

group_ctf <-
  country_list %>%
  left_join(
    ctf,
    by = "country_code"
  ) %>%
  group_by(
    group_code, group
  ) %>%
  summarise(
    across(
      c(all_of(vars_ctf)),
      ~ median(., na.rm = TRUE)
    )
  ) %>%
  filter(!is.na(group)) %>%
  rename(
    country_name = group,
    country_code = group_code
  )

# static
ctf <- tibble::add_column(ctf, country_group = 0, .after = "country_code")
group_ctf <- tibble::add_column(group_ctf, country_group = 1, .after = "country_code")


group_ctf_dynamic <- country_list %>%
  left_join(
    ctf_dynamic,
    by = "country_code",
  ) %>%
  group_by(
    group_code, group, year
  ) %>%
  summarise(
    across(
      c(all_of(vars_ctf)),
      ~ median(., na.rm = TRUE)
    )
  ) %>%
  filter(!is.na(group)) %>%
  rename(
    country_name = group,
    country_code = group_code
  )


# dynamic
ctf_dynamic <- add_column(ctf_dynamic, country_group = 0, .after = "country_code")
group_ctf_dynamic <- add_column(group_ctf_dynamic, country_group = 1, .after = "country_code")
```

## 7. Clean CTF data and incorporate logged GDP per capita

```{r}
# static
ctf_clean <-
  ctf %>%
  # add country codes and names
  left_join(
    country_list |> distinct(country_code, country_name),
    by = c("country_code")
  ) |>
  # add gdp per capita (PPP) data
  # use average value (as in legacy ctf)
  left_join(
    country_average |> select(country_code, wdi_nygdppcapppkd),
    by = c("country_code")
  ) |>
  # rename and transform gdp per capita to log
  mutate(
    log_gdp = log(wdi_nygdppcapppkd)
  ) |>
  bind_rows(group_ctf) %>%
  ungroup() %>%
  arrange(country_name) |>
  select(
    country_code,
    country_name,
    everything()
  )

# dynamic
ctf_dynamic_clean <-
  ctf_dynamic %>%
  # add country codes and names
  left_join(
    country_list |> distinct(country_code, country_name),
    by = c("country_code")
  ) |>
  # add gdp per capita (PPP) data
  left_join(
    cliar_indicators |> select(country_code, year, wdi_nygdppcapppkd),
    by = c("country_code", "year")
  ) |>
  # rename and transform gdp per capita to log
  mutate(
    log_gdp = log(wdi_nygdppcapppkd)
  ) |>
  bind_rows(group_ctf_dynamic) %>%
  ungroup() %>%
  arrange(country_name) |>
  select(
    country_code,
    country_name,
    everything()
  )
```


## 8. Convert to long-form

This changes the CTF dataset from wide form to long for and adds some additional 
data such as indicator family
```{r}
# static
ctf_long <-
  ctf_clean %>%
  pivot_longer(
    all_of(vars_ctf),
    names_to = "variable"
  ) %>%
  select(-contains("gdp")) %>%
  left_join(
    db_variables %>%
      select(variable, var_name, family_name, family_var),
    by = "variable"
  ) %>%
  left_join(
    country_list %>%
      select(country_code, group),
    by = "country_code",
  )

ctf_long_clean <-
  ctf_long %>%
  group_by(family_name, family_var, country_name, country_code, group, country_group) %>%
  summarise(value = median(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    variable = family_var,
    var_name = family_name
  ) %>%
  bind_rows(ctf_long)

# dynamic
ctf_dynamic_long <-
  ctf_dynamic_clean %>%
  pivot_longer(
    all_of(vars_ctf),
    names_to = "variable"
  ) %>%
  select(-contains("gdp")) %>%
  left_join(
    db_variables %>%
      select(variable, var_name, family_name, family_var)
  ) %>%
  left_join(
    country_list %>%
      select(country_code, group),
    by = "country_code",
  )

ctf_dynamic_long_clean <-
  ctf_dynamic_long %>%
  group_by(family_name, family_var, country_name, country_code, country_group, group, year) %>%
  summarise(value = median(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    variable = family_var,
    var_name = family_name
  ) %>%
  bind_rows(ctf_dynamic_long)
```

## 9. Calculate family level data

Find the average ctf of all indicators in a family

### Static

```{r}
# group by unique rows 
ctf_long_clean_family_level <- ctf_long_clean %>%
  distinct(family_name, family_var, country_name, country_code,
    group, variable, var_name, country_group,
    .keep_all = TRUE
  ) %>%
  group_by(
    family_name, family_var, country_name, country_code,
    country_group
  ) %>%
  
  summarise(value = mean(value[family_name != var_name], na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(
    variable = paste0(family_var, "_avg"),
    var_name = (paste0(family_name, " Average"))
  ) %>%
  left_join(ctf_long_clean %>%
    distinct(
      family_name, family_var, country_name,
      country_code, group, country_group
    )) %>%
  ungroup()

## Attach this to ctf_long_clean
ctf_long_clean <- ctf_long_clean %>%
  bind_rows(ctf_long_clean_family_level) %>%
  arrange(
    family_name, family_var, country_name, country_code,
    group, variable, var_name
  )

## Convert it to wide format and attach it to ctf_clean
ctf_clean <- ctf_long_clean_family_level %>%
  select(-group) %>%
  distinct() %>%
  select(-family_name, -family_var, -var_name) %>%
  mutate(value = ifelse(is.nan(value), NA, value)) %>%
  pivot_wider(names_from = "variable", values_from = "value") %>%
  full_join(ctf_clean, ., by = c("country_code", "country_name", "country_group"))
```

### Dynamic

```{r}
ctf_dynamic_long_clean_family_level <- ctf_dynamic_long_clean %>%
  distinct(family_name, family_var, country_name, country_code,
    group, variable, var_name,  year, country_group,
    .keep_all = TRUE
  ) %>%
  group_by(
    family_name, family_var, country_name, country_code,
    country_group, year
  ) %>%
  summarise(value = mean(value[family_name != var_name], na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(
    variable = paste0(family_var, "_avg"),
    var_name = (paste0(family_name, " Average"))
  ) %>%
  left_join(ctf_dynamic_long_clean %>%
    distinct(
      family_name, family_var, country_name,
      country_code, group, year, country_group
    )) %>%
  ungroup()

## Attach this to ctf_dynamic_long_clean
ctf_dynamic_long_clean <- ctf_dynamic_long_clean %>%
  bind_rows(ctf_dynamic_long_clean_family_level) %>%
  arrange(
    family_name, family_var, country_name, country_code,
    group,year, variable, var_name
  )

## Convert it to wide format and attach it to ctf_dynamic_clean
ctf_dynamic_clean <- ctf_dynamic_long_clean_family_level %>%
  select(-group) %>%
  distinct() %>%
  select(-family_name, -family_var, -var_name) %>%
  mutate(value = ifelse(is.nan(value), NA, value)) %>%
  pivot_wider(names_from = "variable", values_from = "value") %>%
  full_join(ctf_dynamic_clean, ., by = c("country_code", "country_name", "country_group", "year"))


```


## 9.  Data Quality Control
Test that all expected countries and indicators are covered
```{r}
test_that(
  "All countries are covered",
  {
    expect_setequal(
      ctf_clean |> filter(country_group == 0) |> distinct(country_code) |> pull(),
      country_list |> distinct(country_code) |> pull()
    )
    expect_setequal(
      ctf_dynamic_clean |> filter(country_group == 0) |> distinct(country_code) |> pull(),
      country_list |> distinct(country_code) |> pull()
    )
  }
)

test_that(
  "All indicators are covered",
  {
    ## Shel added _avg to the pattern to take care of the new family level indicators (that all have an _avg suffix)
    expect_setequal(
      ctf_clean |> colnames() |> str_subset("year|country|gdp|_avg$", negate = TRUE),
      vars_ctf
    )
    expect_setequal(
      ctf_dynamic_clean |> colnames() |> str_subset("year|country|gdp|_avg$", negate = TRUE),
      vars_ctf
    )
  }
)
```


## 10. Update db_variables to contain the family averages

```{r}
## temporarily clean the family names

db_variables <- db_variables %>% 
                 mutate(family_name = ifelse(family_name == "Justice institutions", "Justice Institutions",
                   ifelse(family_name == "Political institutions" , "Political Institutions" ,
                     family_name
                   )))


db_variables<-db_variables %>% 
  mutate(across(where(is.character), str_squish))

## add a temporary rank id within family in db_variables
set.seed(1957)
generate_random_sequence <- function(length) {
  return(sample(1:length, length, replace = FALSE))
}

db_variables<-db_variables %>% 
  group_by(family_var) %>% 
  mutate(rank_id = generate_random_sequence(n())) %>% 
  ungroup() %>% 
  mutate(rank_id = rank_id + 1)



## add family level vars
family_level_vars <- db_variables %>% 
  distinct(family_var, family_name) %>% 
  rowwise() %>% 
  mutate(variable = paste0(family_var, "_avg"),
    var_name = paste0(family_name, " Average"),
    var_level = "indicator" ) %>% 
  mutate(benchmarked_ctf = "Yes")

db_variables <- db_variables %>% 
  bind_rows(family_level_vars) %>% 
  arrange(family_var) %>% 
  mutate(rank_id = ifelse(variable %in% grep("_avg", variable, value = T), 
    1, rank_id)) %>% 
  arrange(family_var, rank_id)
```

## 11. Write-out data

```{r}
write_rds(
  ctf_clean,
  here(
    "data",
    "output",
    "closeness_to_frontier.rds"
  )
)

write_rds(
  ctf_long_clean,
  here(
    "data",
    "output",
    "closeness_to_frontier_long.rds"
  )
)

write_rds(
  ctf_dynamic_clean,
  here(
    "data",
    "output",
    "closeness_to_frontier_dynamic.rds"
  )
)

write_rds(
  ctf_dynamic_long_clean,
  here(
    "data",
    "output",
    "closeness_to_frontier_dynamic_long.rds"
  )
)

write_rds(
  db_variables,
  here(
    "data",
    "output",
    "db_variables.rds"
  )
)
```

