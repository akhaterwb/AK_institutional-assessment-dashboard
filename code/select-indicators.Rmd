# Process selected indicators

- Input: `data/select_indicators.csv`
- Outputs: 
  - `data/final/definitions.rds`

## Load packages

```{r}
packages <- 
  c(
    "tidyverse",
    "here",
    "data360r",
    "readxl"
  )

pacman::p_load(
  packages, 
  character.only = TRUE
)
```


## Load list of selected indicators

This list is filled by hand in Excel.

```{r}
db_variables <-
  read_csv(
    here(
      "..",
      "data",
      "indicator_selection.csv"
    )
  )
```

## Retrieve metadata from API

For variables extracted from the Gov360 API, we want to make sure we are using the latest metadata from the API.

```{r}
# Extract meta data
metadata_gov <-
  get_metadata360(site = "gov", metadata_type = "indicators") 

metadata_tc <-
  get_metadata360(site = "tc", metadata_type = "indicators") 

metadata <-
  bind_rows(metadata_gov, metadata_tc) %>%
  unique %>%
  select(
    api_id = id,
    description = definition,
    source = dataset
  )

# Combine with meta data about indicators not on the API
db_variables <-
  left_join(
    db_variables,
    metadata,
    by = "api_id"
  )

# Replace missing values with data from API
db_variables <-
  db_variables %>%
  mutate(
    description = coalesce(description.y, description.x),
    source = coalesce(source.y, source.x)
  ) %>%
  select(-contains(".x"), -contains(".y"))
```

## Save list of selected indicators in R format

```{r}
write_rds(
  db_variables,
  here(
    "..",
    "data",
    "final",
    "db_variables.rds"
  )
)
```

## Save variable definitions by family

```{r}
description <- 
  function(x) {
    assign(
      x,
      db_variables %>%
        filter(family_name == x) %>%
        select(
          Indicator = var_name,
          Description = description,
          Source = source
        )
    )
  }

description <-
  lapply(
    unique(db_variables$family_name),
    description
  )

names(description) <- 
  unique(db_variables$family_name)

write_rds(
  description,
  here(
    "..",
    "data",
    "final",
    "definitions.rds"
  )
)
```

## Define list of variables

```{r}
source(here("vars-control.R"))
```
