---
title: "Data Quality Control: Validation"
output: html_document
date: '`r format(Sys.Date(), "%B %d, %Y")`'
---

```{r setup, include = FALSE}
library(dplyr)
library(ggplot2)
library(here)
library(testthat)
library(naniar)
library(tidytext)
library(readr)
library(pointblank)

# note that echo has to be set TRUE to display pointblank output
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, 
  fig.width = 10, fig.height = 14, dpi = 300
)

validate_rmd()
```

```{r, include = FALSE}
full_data <- read_rds(
  here(
    "..",
    "data",
    "final",
    "compiled_indicators.rds"
  )
)

# variable definitions
db_variables <- read_rds(
   here(
    "..",
    "data",
    "final",
    "db_variables.rds"
  )
)

# import variable definitions
source(
  here("vars-control.R")
)

# knitr::opts_chunk$set(eval = FALSE)
```

# Introduction:

This document provides a protocol for data validation when manually importing data into CLIAR. The goal is to mitigate the following risks:

  1. Change in data structure and indicator names over time.
  2. Inconsistency in country names and codes across data sources.

# Steps for Validation of Manual Data Import:

  1. **Document data source:** For each data source, specify (a) the `url` to download the data, (b) where the data is stored and (c) when the data was downloaded.
  2. **Set expectations in a data import template:** To ensure consistency in data entry, there will be data import template for each data source. Each template specifies the indicators and data types.
  3. **Validate the data:** We use the package `pointblank` to validate the dataset. We specify rules to detect errors and inconsistencies in the data, such as missing or invalid values, incorrect formatting, or duplicates.
  4. **Review and approve the data import:** The diagnostic is reviewed and approved by a designated individual or team for each data import This ensures that the data meets the necessary review standards.
  5. **Store the data for each data source:** Imported data for each data source is stored in a designated location that is easily accessible to authorized individuals.

Data validation will be performed using the `R` package [`pointblank`](https://rich-iannone.github.io/pointblank/).

# How to Validate a Manual Import of Data:

Below, we provide a code example of how to validate a manual import of data.

```{r, echo = FALSE}
# library(tidyverse)
# library(lubridate)
# library(readxl)

```


## 1. Document Data Source

This section specifies both the data source and location of the imported data file:

- Data Source: `url`
- Data Location: `/path/to/file1.xlsx`
- Data Import Date: `r format(Sys.Date(), "%B %d, %Y")`

Here we also specify what steps were taken during the import process, issues found and solutions implemented.

## 2. Set Expectations in a Data Import Template

This defines our expectations of the expected format of the data. This should specify both the type of indicator (e.g., `string`, `integer`),  as well as indicator names.

We verify that all relevant indicators are contained in the dataset, as specified by all variables contained in `vars_all`.

```{r validate = TRUE, echo = TRUE}
full_data |> 
  col_exists(
    columns = c(vars_all)
  ) 
```

## 3. Validate the Data

In this section, we define our expectations of the structure of the data. For example, whether it contains all the columns outlined in the `data_template` specified above. Additionally, whether it contains any missing values. 

These should be specified on a data source basis, but will be crucial for ensuring that we have validation procedures set in place.

In this example, we conduct validation tests on two sets of indicators: (1) Freedom House and (2) PEFA. The test is specified as: "No more than 10% of the values should be above a certain threshold". Note that because PEFA has so many missing values (96%), it fails its test.

```{r validation, validate = TRUE, echo = TRUE}
al <- action_levels(
  warn_at = 0.1
)

full_data |> 
  create_agent() |>
  # verify that freedom-house columns are less than or equal to 7
  col_vals_lte(
    columns = starts_with("e_fh"),
    value = 7,
    label = "Verify Freedom House indicators are less than 7",
    actions = al
  ) |>
  col_vals_lte(
    columns = starts_with("pefa_"),
    value = 4,
    label = "Verify PEFA indicators are less than 4",
    actions = al
  ) |>
  interrogate()
```

## 4. Review and approve the data import

In this review section, we document our interpretation of the diagnostics, as well as whether or not we have approved the data import. We should also specify who approved it.

## 5. Store the data

We should ideally store the approved data in a centralized data infrastructure, as discussed in our knowledge transfer meeting. We should avoid to the extent possible having local copies of the same data.

```{r, eval = FALSE}
# Store data
saveRDS(data_raw, "/path/to/data_raw.rds")
saveRDS(data_quality, "/path/to/data_quality.rds")
```


## Appendix 1: Full Summary of Indicators

**Note:** We should add information on the different sources for each one of the indicators. Additionally, there should be a common prefix

```{r echo = TRUE, eval = TRUE}
scan_data(
  full_data,
  sections = "OVS"
)
```
